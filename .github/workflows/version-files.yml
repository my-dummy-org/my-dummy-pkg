# Bumps version in files and creates PR when a PR with version label is merged to main

# Pipeline:
# 1. Triggered on push to main (only PR merge commits if main branch is protected)
# 2. Retrieves merged PR labels to resolve semver level
# 3. Resolved semver level passed to `npm version` command to resolve and set (in package.json) version number
# 4. Resolved version number used to create git version branch
# 5. Commits updated files (package.json) to version branch
# 6. Pushes version branch to remote origin (GitHub)
# 7. Creates Pull Request for that pushed version branch

# Requirements:
# - required labels: major, minor, patch, version-files
# - merged PR must have assigned label: major | minor | patch
# - secrets.APP_ID
# - secrets.APP_PRIVATE_KEY

name: Bump version in files

on:
  push:
    tags-ignore:
      - '*' # Do not run on pushed tags
    branches:
      - main # Run only on push to main

permissions:
  id-token: write # Required for OIDC trusted publishing authentication
  contents: write # Required to push a new tag
  pull-requests: write # Required to create PR to push branch with new version files

jobs:
  version-files:
    runs-on: ubuntu-latest

    env:
      MAIN_BRANCH: 'main'
      VERSION_BRANCH_PREFIX: 'version/v'
      VERSION_FILES_LABEL: 'version-files'

    steps:
      - name: Prepare GitHub bot app credentials
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Get merged PR
        id: get-merged-pull-request
        # Continue only if has GitHub bot app token
        if: |
          steps.app-token.outputs.token != null
        uses: actions-ecosystem/action-get-merged-pull-request@v1
        with:
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Resolve semver level from PR labels
        id: release-label
        # Continue only if has GitHub bot app token
        # Continue only if PR has labels
        if: |
          steps.app-token.outputs.token != null &&
          steps.get-merged-pull-request.outputs.labels != null
        uses: actions-ecosystem/action-release-label@v1
        with:
          # Disable default prefix for labels (release/major -> major)
          label_prefix: ''
          # Labels (separated with line breaks):
          #   - major
          #   - minor
          #   - patch
          labels: ${{ steps.get-merged-pull-request.outputs.labels }}

      - name: Checkout code
        # Continue only if has GitHub bot app token
        # Continue only with resolved semver level from PR
        if: |
          steps.app-token.outputs.token != null &&
          steps.release-label.outputs.level != null
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        # Continue only if has GitHub bot app token
        # Continue only with resolved semver level from PR
        if: |
          steps.app-token.outputs.token != null &&
          steps.release-label.outputs.level != null
        uses: actions/setup-node@v6
        with:
          node-version: '24.5.0'

      - name: Resolve and set version in package.json
        # Continue only if has GitHub bot app token
        # Continue only with resolved semver level from PR
        if: |
          steps.app-token.outputs.token != null &&
          steps.release-label.outputs.level != null
        # Resolve new version number using semver level and set it in package.json
        # --no-git-tag-version to disable git commit and tag generation (only supports manual signing)
        run: npm version ${{ steps.release-label.outputs.level }} --no-git-tag-version

      - name: Read version from package.json
        id: read-version
        # Continue only if has GitHub bot app token
        # Continue only with resolved semver level from PR
        if: |
          steps.app-token.outputs.token != null &&
          steps.release-label.outputs.level != null
        shell: bash
        run: |
          new_version=$(npm pkg get version | tr -d '"')
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

      - name: Get GitHub App User ID
        id: get-app-user-id
        # Continue only if has GitHub bot app token
        # Continue only with new semver version number
        # Continue only with resolved GPG key
        if: |
          steps.app-token.outputs.token != null &&
          steps.read-version.outputs.new_version != null
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          app_user_id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)
          echo "app_user_id=$app_user_id" >> $GITHUB_OUTPUT

      - name: Setup git credentials
        # Continue only if has GitHub bot app token
        # Continue only with new semver version number
        # Continue only with resolved GPG key
        if: |
          steps.app-token.outputs.token != null &&
          steps.read-version.outputs.new_version != null
        run: |
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-app-user-id.outputs.app_user_id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Create version branch
        # Continue only if has GitHub bot app token
        # Continue only with new semver version number
        # Continue only with resolved GPG key
        if: |
          steps.app-token.outputs.token != null &&
          steps.read-version.outputs.new_version != null
        shell: bash
        run: git checkout -b ${{ env.VERSION_BRANCH_PREFIX }}${{ steps.read-version.outputs.new_version }}

      - name: Push version branch
        # Continue only if has GitHub bot app token
        # Continue only with new semver version number
        # Continue only with resolved GPG key
        if: |
          steps.app-token.outputs.token != null &&
          steps.read-version.outputs.new_version != null
        shell: bash
        run: git push -u origin ${{ env.VERSION_BRANCH_PREFIX }}${{ steps.read-version.outputs.new_version }}

      - name: Commit changes
        # Continue only if has GitHub bot app token
        # Continue only with new semver version number
        # Continue only with resolved GPG key
        if: |
          steps.app-token.outputs.token != null &&
          steps.read-version.outputs.new_version != null
        uses: iarekylew00t/verified-bot-commit@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          auto-stage: true
          ref: 'refs/heads/${{ env.VERSION_BRANCH_PREFIX }}${{ steps.read-version.outputs.new_version }}'
          message: 'Version bump to v${{ steps.read-version.outputs.new_version }}'
          files: |
            **

      - name: Create Pull Request
        # Continue only if has GitHub bot app token
        # Continue only with new semver version number
        # Continue only with resolved GPG key
        if: |
          steps.app-token.outputs.token != null &&
          steps.read-version.outputs.new_version != null
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh pr create \
            --base ${{ env.MAIN_BRANCH }} \
            --label ${{ env.VERSION_FILES_LABEL }} \
            --head ${{ env.VERSION_BRANCH_PREFIX }}${{ steps.read-version.outputs.new_version }} \
            --title "Version bump to v${{ steps.read-version.outputs.new_version }}" \
            --body "Bump version in files to v${{ steps.read-version.outputs.new_version }}"
