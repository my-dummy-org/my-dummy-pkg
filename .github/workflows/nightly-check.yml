name: Nightly check for new version

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 * * *' # runs every day at 00:00 UTC (midnight)

jobs:
  new-version-check:
    name: Check gifsicle new version
    runs-on: ubuntu-latest
    steps:
      - name: Get latest gifsicle tag
        id: gifsicle-latest-tag
        shell: bash
        run: |
          echo "tag=$(git ls-remote --tags https://github.com/kohler/gifsicle.git \
            | tail -n1 \
            | grep -o 'refs/tags/.*' \
            | cut -d/ -f3)" >> $GITHUB_OUTPUT

      # TODO: Does not check for semver tag form (use both when publishing)
      - name: Get own gifsicle tag
        id: gifsicle-own-tag
        shell: bash
        run: |
          echo "tag=$(git ls-remote --tags https://github.com/${{ github.repository }}.git \
            refs/tags/v${{ steps.gifsicle-latest-tag.outputs.tag }} \
            | grep -o 'refs/tags/.*' \
            | cut -d/ -f3)" >> $GITHUB_OUTPUT

      - name: Tag to version
        id: gifsicle-latest-version
        if: ${{ steps.gifsicle-latest-tag.outputs.tag != steps.gifsicle-own-tag.outputs.tag }}
        shell: bash
        run: |
          tag="${{ steps.gifsicle-latest-tag.outputs.tag }}"
          version="${tag#v}"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Print resolved version
        if: ${{ steps.gifsicle-latest-tag.outputs.tag != steps.gifsicle-own-tag.outputs.tag }}
        shell: bash
        run: echo "resolved version ${{ steps.gifsicle-latest-version.outputs.version }}"

    outputs:
      gifsicle-version: ${{ steps.gifsicle-latest-version.outputs.version }}

  call-dep-check:
    name: Run dependency checks
    needs: new-version-check
    if: |
      needs.new-version-check.outputs.gifsicle-version != null &&
      needs.new-version-check.outputs.gifsicle-version != ''
    uses: ./.github/workflows/dep-check.yml
    permissions:
      contents: read
      id-token: write
      packages: write
    secrets: inherit
    with:
      gifsicle-version: ${{ needs.new-version-check.outputs.gifsicle-version }}
      emscripten-version: '4.0.20'
      patch-version: '0'

  bump-version:
    name: Bump version
    needs: call-dep-check
    runs-on: ubuntu-latest
    steps:
      - name: Print dependency check success message
        shell: bash
        run: echo "Dependency check success"
